import{h as A,u as F,b as M,r as o,j as a,a as k,f as L,D}from"./index-CxzMjhE-.js";import{u as Q}from"./useBoard-BWIqxM7N.js";import{a as U}from"./useSocket-B9IG26Ws.js";import{u as _}from"./usePermissions-alxmqwVa.js";import{B as y}from"./Board-DvHUsBFG.js";import{D as R,B as $}from"./BoardSearchFilter-D2vJmDlZ.js";import{a as G}from"./quest-3nETprwz.js";import{t as H}from"./displayUtils-C2lD-HWY.js";import"./post-BFgSlzkn.js";import"./Button-BBg8DJkg.js";import"./GridLayout-DEWRpfJd.js";import"./useGraph-Br1XlEWj.js";import"./AvatarStack-DgfcvvW3.js";const oe=()=>{const{id:r}=A(),{socket:n}=U(),{canEditBoard:B}=_(),{user:d}=F(),{setBoardMeta:f}=M(),{board:e,setBoard:j,isLoading:E,refresh:h}=Q(r),[S,x]=o.useState(null),[I,w]=o.useState(1),[c,b]=o.useState(!1),[N,q]=o.useState(!0),[C,P]=o.useState([]),[T,v]=o.useState(R),l=o.useCallback(async s=>{try{const t=await G(s);x(t)}catch(t){console.warn("[BoardPage] Failed to load quest:",t)}},[]),m=o.useCallback(()=>{h().then(s=>{s!=null&&s.questId&&l(s.questId)})},[h,l]);o.useEffect(()=>{if(!(!n||!r))return n.emit("join",{room:`board-${r}`}),n.on("board:update",m),()=>{n.emit("leave",{room:`board-${r}`}),n.off("board:update",m)}},[n,r,m]),o.useEffect(()=>{if(e){f({id:e.id,title:e.title,layout:e.layout}),e.questId?l(e.questId):x(null);const s=new Set;(e.enrichedItems||[]).forEach(t=>{(t.tags||[]).forEach(i=>s.add(i))}),P(Array.from(s))}},[e,f,l]);const g=async()=>{var s;if(!(!r||c||!N)){b(!0);try{const t=await L(r,{page:I+1,limit:D,enrich:!0,userId:d==null?void 0:d.id});(s=t==null?void 0:t.items)!=null&&s.length?(j(i=>i&&{...i,items:[...i.items,...t.items],enrichedItems:[...i.enrichedItems||[],...t.enrichedItems||[]]}),w(i=>i+1)):q(!1)}catch(t){console.warn("[BoardPage] Pagination error:",t)}finally{b(!1)}}};if(E)return a.jsx(k,{});if(!e)return a.jsx("div",{className:"p-6 text-center text-red-500",children:"Board not found."});const u=B(e.id),p=e.id==="timeline-board";return a.jsx("main",{className:"max-w-7xl mx-auto p-4 space-y-8 bg-board-bg",children:a.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[!p&&a.jsx($,{tags:C,className:"md:w-64",onChange:v}),a.jsx("div",{className:"flex-1",children:a.jsxs("div",{className:"bg-board-bg rounded-xl shadow-lg p-6 space-y-6",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h1",{className:"text-3xl font-bold text-primary dark:text-primary",children:H(e.title)}),u&&a.jsx("button",{className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Edit Board"})]}),p?a.jsx(y,{boardId:r,board:e,layout:"list",compact:!0,hideControls:!0,onScrollEnd:g,loading:c}):a.jsx(y,{boardId:r,board:e,layout:"list",quest:S||void 0,editable:u,showCreate:u,hideControls:!0,filter:T,onScrollEnd:g,loading:c})]})})]})})};export{oe as default};
