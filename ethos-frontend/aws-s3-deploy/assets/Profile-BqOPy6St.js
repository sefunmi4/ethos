import{u as C,r as i,j as e,a as w,E as B,L as Q,R}from"./index-CxzMjhE-.js";import{u as S}from"./useBoard-BWIqxM7N.js";import{u as P}from"./useSocket-B9IG26Ws.js";import{B as q}from"./Banner-C5qimYCt.js";import{B as F}from"./Board-DvHUsBFG.js";import{D as U,B as D}from"./BoardSearchFilter-D2vJmDlZ.js";import{f as M}from"./quest-3nETprwz.js";import{f as O,a as T}from"./post-BFgSlzkn.js";import{C as z,Q as Y}from"./GridLayout-DEWRpfJd.js";import{B as W}from"./Button-BBg8DJkg.js";import"./usePermissions-alxmqwVa.js";import"./displayUtils-C2lD-HWY.js";import"./useGraph-Br1XlEWj.js";import"./AvatarStack-DgfcvvW3.js";const _=({onlyMine:h})=>{const{user:d}=C(),[a,g]=i.useState([]),[f,y]=i.useState(!1),[u,b]=i.useState(0),[v,x]=i.useState(!1),p=i.useRef(null),c=i.useRef(0);i.useEffect(()=>{if(!d)return;(async()=>{y(!0);try{const[r,n]=await Promise.all([M(),O(void 0,1)]),o={};r.forEach(t=>{o[t.id]={...t}}),n.forEach(t=>{var N,j;if(!t.questId||!o[t.questId])return;const m=o[t.questId];(!m.lastLog||(t.createdAt||t.timestamp)>(((N=m.lastLog)==null?void 0:N.createdAt)||((j=m.lastLog)==null?void 0:j.timestamp)||""))&&(o[t.questId]={...m,lastLog:t})}),await Promise.all(r.map(async t=>{if(!o[t.id].lastLog&&t.headPostId)try{const m=await T(t.headPostId);o[t.id].lastLog=m}catch{}}));let l=Object.values(o);h&&(l=l.filter(t=>t.authorId===(d==null?void 0:d.id))),g(l)}catch(r){console.warn("[ActiveQuestBoard] Failed to load quests",r),g([])}finally{y(!1)}})()},[d]);const I=s=>{const r=p.current;if(!r)return;const n=r.children[s];n&&n.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})},L=s=>{b(r=>{const n=(r+s+a.length)%a.length;return I(n),c.current=n,n})};i.useEffect(()=>{c.current=u},[u]),i.useEffect(()=>{a.length>0&&I(c.current)},[a.length]),i.useEffect(()=>{const s=p.current;if(!s)return;const r=()=>{const{scrollLeft:n,clientWidth:o}=s;let l=0,t=1/0;Array.from(s.children).forEach((m,N)=>{const j=m,A=j.offsetLeft+j.clientWidth/2,E=Math.abs(A-n-o/2);E<t&&(t=E,l=N)}),l!==c.current&&(c.current=l,b(l))};return s.addEventListener("scroll",r,{passive:!0}),()=>{s.removeEventListener("scroll",r)}},[a]);const k=s=>{g(r=>[s,...r]),x(!1)};return d?f?e.jsx(w,{}):a.length===0?null:e.jsxs("div",{className:"space-y-4 bg-background p-4 rounded shadow-md",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"üß≠ Active Quests"}),d&&e.jsx(W,{variant:"contrast",size:"sm",onClick:()=>x(s=>!s),children:v?"- Cancel Quest":"+ Add Quest"})]}),v&&e.jsx("div",{className:"border rounded-lg p-4 shadow",children:e.jsx(z,{onSave:k,onCancel:()=>x(!1),boardId:"quest-board"})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{ref:p,className:"flex overflow-x-auto gap-4 snap-x snap-mandatory px-2 pb-4 scroll-smooth",children:a.map((s,r)=>e.jsx("div",{className:"snap-center flex-shrink-0 w-[90%] sm:w-[850px] transition-transform duration-300 "+(r===u?"scale-100":Math.abs(r-u)===1?"scale-95 opacity-80":"scale-90 opacity-50"),children:e.jsx(B,{children:e.jsx(Y,{quest:s,user:d})})},s.id))}),a.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:()=>L(-1),className:"absolute left-0 top-1/2 -translate-y-1/2 bg-surface hover:bg-background rounded-full shadow p-1",children:"‚óÄ"}),e.jsx("button",{type:"button",onClick:()=>L(1),className:"absolute right-0 top-1/2 -translate-y-1/2 bg-surface hover:bg-background rounded-full shadow p-1",children:"‚ñ∂"})]})]}),e.jsx("div",{className:"flex justify-center mt-2",children:(()=>{const s=a.length>3?[u-1,u,u+1]:a.map((r,n)=>n);return s.map((r,n)=>{const o=(r%a.length+a.length)%a.length,l=o===u,t=n===0||n===s.length-1;return e.jsx("button",{type:"button",onClick:()=>b(o),className:"mx-1 w-2 h-2 rounded-full transition-all "+(l?"bg-accent opacity-100":"bg-secondary/40 opacity-70")+(t&&!l?" scale-75":"")},n)})})()})]}):null},oe=()=>{var p;const{user:h,loading:d}=C(),{board:a,setBoard:g}=S("my-quests",{pageSize:1e3}),{board:f,setBoard:y,isLoading:u}=S("my-posts",{pageSize:1e3}),[b,v]=i.useState(U);if(P("board:update",c=>{!c||!h||(c.id===(a==null?void 0:a.id)&&g(c),c.id===(f==null?void 0:f.id)&&y(c))}),d)return e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(w,{})});if(!h||!h.username)return e.jsx("div",{className:"text-center py-12 text-red-500",children:"You must be logged in to view your profile."});const x=h;return e.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl bg-soft dark:bg-soft-dark text-primary",children:[e.jsx(q,{user:x}),e.jsxs("section",{className:"mb-12",children:[e.jsx(_,{onlyMine:!0}),e.jsx("div",{className:"text-right",children:e.jsx(Q,{to:R.BOARD("active"),className:"text-sm text-blue-600 underline",children:"‚Üí See all"})})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-2xl font-semibold text-primary mb-4",children:"üìù Your Post History"}),u?e.jsx(w,{}):e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx(D,{className:"md:w-64",onChange:v}),e.jsxs("div",{className:"flex-1",children:[e.jsx(F,{boardId:"my-posts",board:f,layout:"list",user:x,compact:!0,hideControls:!0,filter:b,headerOnly:!0}),((p=f==null?void 0:f.enrichedItems)==null?void 0:p.length)===0&&e.jsx("div",{className:"text-secondary text-center py-8",children:"You haven't posted anything yet."})]})]})]})]})};export{oe as default};
