import{r as n,j as s,I as ne,S,s as Ee,t as Me,a as ve,b as Fe,f as se,v as ae}from"./index-CxzMjhE-.js";import{u as Re}from"./usePermissions-alxmqwVa.js";import{u as Ge}from"./useSocket-B9IG26Ws.js";import{g as Y,t as Oe}from"./displayUtils-C2lD-HWY.js";import{B as w}from"./Button-BBg8DJkg.js";import{F as ge,L as R,T as Ve,S as $e,B as Qe,V as De,c as Pe,b as _e,C as qe,a as ze,M as Ke,G as xe,e as H}from"./GridLayout-DEWRpfJd.js";const He=l=>{var i;const d=new Set,I=new Set;l.forEach(c=>{"headPostId"in c&&I.add(c.id)});const T=[];for(const c of l)if(!d.has(c.id)){if(d.add(c.id),!("headPostId"in c)){const g=c.questId,B=(i=c.linkedItems)==null?void 0:i.find(j=>j.itemType==="quest"&&I.has(j.itemId));if(g&&I.has(g)||B)continue}T.push(c)}return T},Ye=({board:l,onSave:d,onCancel:I,onDelete:T})=>{var V;const[i,c]=n.useState(l.title||""),[g,B]=n.useState(l.description||""),[j,G]=n.useState(l.layout||"grid"),[h,A]=n.useState(l.boardType||"post"),[C,p]=n.useState(((V=l.filters)==null?void 0:V.visibility)||"public"),[u,L]=n.useState(l.category||""),[b,e]=n.useState(l.items||[]),[N,Q]=n.useState(!1),E=l.enrichedItems||[],O=(r,m)=>{const y=[...b],[$]=y.splice(r,1);y.splice(m,0,$),e(y)},k=async r=>{r.preventDefault(),Q(!0);const m={title:i.trim(),description:g.trim(),boardType:h,layout:j,items:b,filters:{visibility:C},category:u.trim()||void 0};try{const y=await Ee(l.id,m);d==null||d(y)}catch(y){console.error("[EditBoard] Failed to save board:",y)}finally{Q(!1)}},D=async()=>{if(window.confirm(`Are you sure you want to delete "${l.title}"?`))try{l.id&&(await Me(l.id),T==null||T(l.id))}catch(r){console.error("[EditBoard] Failed to delete board:",r)}};return s.jsxs("form",{onSubmit:k,className:"space-y-6",children:[s.jsxs(ge,{title:"Board Settings",children:[s.jsx(R,{htmlFor:"title",children:"Title"}),s.jsx(ne,{id:"title",value:i,onChange:r=>c(r.target.value),required:!0}),s.jsx(R,{htmlFor:"description",children:"Description"}),s.jsx(Ve,{id:"description",rows:3,value:g,onChange:r=>B(r.target.value)}),s.jsx(R,{htmlFor:"layout",children:"Structure"}),s.jsx(S,{id:"layout",value:j,onChange:r=>G(r.target.value),options:$e.slice()}),s.jsx(R,{htmlFor:"board-type",children:"Board Type"}),s.jsx(S,{id:"board-type",value:h,onChange:r=>A(r.target.value),options:Qe.slice()}),s.jsx(R,{htmlFor:"visibility",children:"Visibility"}),s.jsx(S,{id:"visibility",value:C,onChange:r=>p(r.target.value),options:De.slice()}),s.jsx(R,{htmlFor:"category",children:"Category"}),s.jsx(ne,{id:"category",value:u,onChange:r=>L(r.target.value),placeholder:"Optional board grouping"})]}),s.jsx(ge,{title:"Reorder Items",children:b.length>0?s.jsx("ul",{className:"space-y-2",children:b.map((r,m)=>{const y=E.find(P=>P.id===r),$=y?Y(y):r?`Item ${m+1}: ${r.slice(-6)}`:`Missing Item ${m+1}`;return s.jsxs("li",{className:"flex justify-between items-center",children:[s.jsx("span",{className:"truncate max-w-xs",children:$}),s.jsxs("div",{className:"flex gap-2",children:[m>0&&s.jsx(w,{type:"button",onClick:()=>O(m,m-1),children:"↑"}),m<b.length-1&&s.jsx(w,{type:"button",onClick:()=>O(m,m+1),children:"↓"})]})]},r??`null-${m}`)})}):s.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No items to reorder."})}),s.jsxs("div",{className:"flex justify-between items-center pt-2",children:[s.jsx(w,{type:"button",variant:"danger",onClick:D,children:"Delete Board"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(w,{type:"button",variant:"ghost",onClick:I,children:"Cancel"}),s.jsx(w,{type:"submit",variant:"primary",disabled:N,children:N?"Saving...":"Save Changes"})]})]})]})},Ue=({items:l,questId:d,user:I,compact:T=!1,onEdit:i,onDelete:c,onScrollEnd:g,loadingMore:B=!1,headerOnly:j=!1,initialExpanded:G=!1,boardId:h,expandedId:A,onExpand:C})=>{const p=n.useRef(null);return n.useEffect(()=>{const u=p.current;if(!u||!g)return;const L=()=>{u.scrollHeight-u.scrollTop<=u.clientHeight+150&&g()};return u.addEventListener("scroll",L),()=>u.removeEventListener("scroll",L)},[g]),!l||l.length===0?s.jsx("div",{className:"text-center text-secondary py-12 text-sm",children:"No contributions found."}):s.jsxs("div",{ref:p,className:"space-y-4 overflow-y-auto max-h-[80vh] px-2",children:[l.map(u=>s.jsx(Pe,{contribution:u,user:I,compact:T,onEdit:i,onDelete:c,questId:d,headerOnly:j,initialShowReplies:G,boardId:h,expanded:A===u.id,onToggleExpand:()=>C==null?void 0:C(A===u.id?null:u.id)},u.id)),B&&s.jsx(ve,{})]})},at=({boardId:l,board:d,title:I,layout:T,user:i,editable:c,readOnly:g=!1,compact:B=!1,showCreate:j=!0,hideControls:G=!1,filter:h={},onScrollEnd:A,loading:C=!1,quest:p,gridLayout:u,initialExpanded:L=!1,headerOnly:b=!1})=>{var ye;const[e,N]=n.useState(d??null),[Q,E]=n.useState(!0),[O,k]=n.useState([]),[D,V]=n.useState(null),r=(l||(d==null?void 0:d.id)||(e==null?void 0:e.id))==="quest-board",{canEditBoard:m}=Re(),{setSelectedBoard:y,appendToBoard:$,boards:P,expandedItemId:Te,setExpandedItemId:je}=Fe(),[U,Ie]=n.useState(""),[_,Se]=n.useState("createdAt"),[J,Ce]=n.useState("desc"),[ie,q]=n.useState(!1),[ke,W]=n.useState(!1),[M,z]=n.useState({itemType:h.itemType||"",postType:h.postType||"",linkType:h.linkType||""});n.useEffect(()=>{z({itemType:h.itemType||"",postType:h.postType||"",linkType:h.linkType||""})},[h.itemType,h.postType,h.linkType]);const we=e!=null&&e.id?(ye=P[e.id])==null?void 0:ye.enrichedItems:void 0;n.useEffect(()=>{var a;if(!(e!=null&&e.id))return;const t=((a=P[e.id])==null?void 0:a.enrichedItems)||[];k(t)},[e==null?void 0:e.id,we]);const Be=i==null?void 0:i.id;n.useEffect(()=>{const t=async()=>{if(!l){console.warn("No boardId provided. Skipping board load."),E(!1);return}E(!0);try{const a=await se(l,{enrich:!0,userId:i==null?void 0:i.id}),o=await ae(l,{enrich:!0,userId:i==null?void 0:i.id});y(l),N(a),k(o)}catch(a){console.error("Error loading board:",a)}finally{E(!1)}};d?(y(d.id),N(d),k(d.enrichedItems||[]),E(!1)):(l&&y(l),t())},[l,d,y,Be]),Ge("board:update",t=>{const a=t;!(e!=null&&e.id)||a.id!==e.id||(se(e.id,{enrich:!0,userId:i==null?void 0:i.id}).then(N),ae(e.id,{enrich:!0,userId:i==null?void 0:i.id}).then(o=>k(o)))});const le=n.useMemo(()=>{const t={...h,...M};let a=[...O];return t.itemType&&(a=a.filter(o=>t.itemType==="quest"?"headPostId"in o:"content"in o)),t.postType&&(a=a.filter(o=>"type"in o&&o.type===t.postType)),t.linkType&&(a=a.filter(o=>{var v;return"linkedItems"in o&&((v=o.linkedItems)==null?void 0:v.some(K=>K.linkType===t.linkType))})),a.filter(o=>(Y(o)??"").toLowerCase().includes(U.toLowerCase())).sort((o,v)=>{const K=_==="createdAt"?o.createdAt??"":Y(o)??"",fe=_==="createdAt"?v.createdAt??"":Y(v)??"";return J==="asc"?K.localeCompare(fe):fe.localeCompare(K)})},[O,h,M,U,_,J]),f=n.useMemo(()=>He(le),[le]),be=f.length>0,oe=n.useMemo(()=>{const t=new Set;return f.forEach(a=>{"headPostId"in a?t.add("quest"):"type"in a&&t.add("post")}),Array.from(t)},[f]),re=n.useMemo(()=>{if((e==null?void 0:e.id)==="quest-board")return["request","review","issue"];const t=new Set;return f.forEach(a=>{"type"in a&&t.add(a.type)}),Array.from(t)},[f,e==null?void 0:e.id]),de=n.useMemo(()=>{const t=new Set;return f.forEach(a=>{var o;"linkedItems"in a&&((o=a.linkedItems)==null||o.forEach(v=>{v.linkType&&t.add(v.linkType)}))}),Array.from(t)},[f]),ce=n.useMemo(()=>f.filter(t=>"headPostId"in t),[f]),F=ce.length===1?ce[0]:null,pe=(t,a)=>{var o;return"headPostId"in t||t.questId===a||((o=t.linkedItems)==null?void 0:o.some(v=>v.itemType==="quest"&&v.itemId===a))},ue=n.useMemo(()=>{if(!F)return!1;const t=F.id;return f.every(a=>pe(a,t))},[F,f]),X=n.useMemo(()=>{if(!F)return f;const t=F.id;return f.filter(a=>pe(a,t))},[f,F]),Z=n.useMemo(()=>X.filter(t=>"type"in t&&t.type==="task"),[X]),Ne=n.useMemo(()=>{const t=new Set(Z.map(a=>a.id));return((p==null?void 0:p.taskGraph)||[]).filter(a=>t.has(a.from)&&t.has(a.to))},[Z,p==null?void 0:p.taskGraph]),he=async t=>{k(a=>[t,...a]),q(!1),e&&$(e.id,t)},ee=D||T||(e==null?void 0:e.layout)||"grid",x=(ee==="graph"||ee==="graph-condensed")&&!ue?"grid":ee,te=n.useMemo(()=>g?!1:typeof c=="boolean"?c:e!=null&&e.id?m(e.id):!1,[g,c,e==null?void 0:e.id,m]),Ae={grid:H,list:Ue,horizontal:H,kanban:H,graph:xe,"graph-condensed":xe,"map-graph":Ke}[x]??H;if(Q)return s.jsx(ve,{});if(!e)return s.jsx("div",{className:"text-error p-4",children:"Board not found."});const Le="bg-board-bg",me="bg-board-bg";return s.jsxs("div",{className:`space-y-4 p-6 rounded-xl shadow-lg max-w-5xl mx-auto ${Le}`,children:[s.jsxs("div",{className:"flex items-center justify-between gap-2 flex-wrap",children:[s.jsx("h2",{className:"text-xl font-semibold text-primary dark:text-primary",children:Oe(I||e.title||"Board")}),s.jsxs("div",{className:"flex gap-2 flex-wrap items-center",children:[!G&&be&&s.jsxs(s.Fragment,{children:[s.jsx(ne,{value:U,onChange:t=>Ie(t.target.value),placeholder:"Filter...",className:"w-40 text-sm"}),oe.length>1&&s.jsx(S,{value:M.itemType,onChange:t=>z(a=>({...a,itemType:t.target.value})),options:[{value:"",label:"All Items"},...oe.map(t=>({value:t,label:t}))]}),re.length>1&&s.jsx(S,{value:M.postType,onChange:t=>z(a=>({...a,postType:t.target.value})),options:[{value:"",label:"All Posts"},...re.map(t=>{const a=_e.find(o=>o.value===t);return{value:t,label:(a==null?void 0:a.label)||t}})]}),de.length>1&&s.jsx(S,{value:M.linkType,onChange:t=>z(a=>({...a,linkType:t.target.value})),options:[{value:"",label:"All Links"},...de.map(t=>({value:t,label:t}))]}),s.jsx(S,{value:_,onChange:t=>Se(t.target.value),options:[{value:"createdAt",label:"Date"},{value:"displayTitle",label:"Node Label"}]}),s.jsx(S,{value:J,onChange:t=>Ce(t.target.value),options:[{value:"asc",label:"Asc"},{value:"desc",label:"Desc"}]}),s.jsx(S,{value:x,onChange:t=>V(t.target.value),options:[{value:"grid",label:"Grid"},{value:"list",label:"List"},{value:"horizontal",label:"Horizontal"},{value:"kanban",label:"Kanban"},...ue?[{value:"graph",label:"Graph"},{value:"graph-condensed",label:"Graph (Condensed)"},{value:"map-graph",label:"Map Graph"}]:[]]})]}),te&&D&&s.jsx(w,{variant:"ghost",size:"sm",onClick:()=>V(null),children:"Reset View"}),j&&i&&s.jsx(w,{variant:"contrast",onClick:()=>q(t=>!t),children:ie?(e==null?void 0:e.boardType)==="quest"?"- Cancel Quest":(e==null?void 0:e.id)==="quest-board"?"- Cancel Request":"- Cancel Item":(e==null?void 0:e.boardType)==="quest"?"+ Add Quest":(e==null?void 0:e.id)==="quest-board"?"+ Add Request":["timeline-board","my-posts"].includes((e==null?void 0:e.id)||"")?"+ Add Post":"+ Add Item"}),te&&s.jsx(w,{variant:"secondary",onClick:()=>W(!0),children:"✏️ Edit Board"})]})]}),j&&ie&&s.jsx("div",{className:`border rounded-lg p-4 shadow ${me}`,children:e.boardType==="quest"?s.jsx(qe,{onSave:he,onCancel:()=>q(!1),boardId:e.id}):s.jsx(ze,{onSave:he,onCancel:()=>q(!1),boardId:e.id,initialType:M.postType||(e.id==="quest-board"?"request":"free_speech")})}),ke?s.jsx("div",{className:`border rounded-lg p-4 shadow ${me}`,children:s.jsx(Ye,{board:e,onCancel:()=>W(!1),onSave:()=>{e!=null&&e.id&&se(e.id,{enrich:!0,userId:i==null?void 0:i.id}).then(t=>{N(t),W(!1),ae(e.id,{enrich:!0,userId:i==null?void 0:i.id}).then(a=>k(a))})}})}):s.jsx(Ae,{items:x==="map-graph"?Z:x==="graph"||x==="graph-condensed"?X:f,compact:B,user:i,onScrollEnd:A,loadingMore:C,questId:(p==null?void 0:p.id)||"",boardId:e==null?void 0:e.id,initialExpanded:L,expandedId:Te,onExpand:je,headerOnly:r||b,editable:te,...x==="map-graph"?{edges:Ne}:x==="graph"||x==="graph-condensed"?{edges:p==null?void 0:p.taskGraph}:{},...x==="graph-condensed"?{condensed:!0}:{},...["grid","list","horizontal","kanban"].includes(x)?{layout:x==="grid"?u:x}:{}})]})};export{at as B,He as g};
