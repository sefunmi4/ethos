import{h as $,u as D,c as A,m as O,r as t,D as R,j as r,a as T,R as k}from"./index-CxzMjhE-.js";import{B as H}from"./Board-DvHUsBFG.js";import{P as L,a as U}from"./GridLayout-DEWRpfJd.js";import{a as _}from"./useSocket-B9IG26Ws.js";import{a as G,b as w}from"./post-BFgSlzkn.js";import"./usePermissions-alxmqwVa.js";import"./displayUtils-C2lD-HWY.js";import"./Button-BBg8DJkg.js";import"./quest-3nETprwz.js";import"./useGraph-Br1XlEWj.js";import"./AvatarStack-DgfcvvW3.js";const te=()=>{var I;const{id:e}=$(),{socket:a}=_(),{user:u}=D(),h=A(),[l]=O(),F=l.get("initialType"),B=l.get("intro")==="1",[s,C]=t.useState(null),[o,x]=t.useState(null),[y,M]=t.useState(null),[p,P]=t.useState(!1),[g,S]=t.useState(!0),[b,j]=t.useState(1),[v,f]=t.useState(!1),E=t.useMemo(()=>!o||!s?null:{...o,title:o.title||"Thread",items:[s.id,...o.items||[]],enrichedItems:[s,...o.enrichedItems??[]]},[o,s]);t.useEffect(()=>{l.get("reply")==="1"&&f(!0)},[l]);const i=t.useCallback(async()=>{if(e)try{const n=await G(e);C(n);const c=await w(e,{enrich:!0,page:1,limit:R});x(c),j(1),S(!0)}catch(n){console.error("[PostPage] Failed to fetch post or replies:",n),M("Failed to load post")}},[e]),N=t.useCallback(async()=>{var n;if(!(!e||p||!g)){P(!0);try{const c=b+1,d=await w(e,{enrich:!0,page:c,limit:R});(n=d.items)!=null&&n.length?(x(m=>m?{...m,items:[...m.items,...d.items],enrichedItems:[...m.enrichedItems??[],...d.enrichedItems??[]]}:d),j(c)):S(!1)}catch(c){console.error("[PostPage] Pagination failed:",c)}finally{P(!1)}}},[e,b,g,p]);return t.useEffect(()=>{e&&i()},[e,i]),t.useEffect(()=>{if(!(!a||!e))return a.emit("join",{room:`post-${e}`}),a.on("post:update",i),()=>{a.emit("leave",{room:`post-${e}`}),a.off("post:update",i)}},[a,e,i]),y?r.jsx("div",{className:"text-center py-12 text-red-500",children:y}):s?r.jsxs("main",{className:"container mx-auto max-w-3xl px-4 py-10 space-y-12 bg-soft dark:bg-soft-dark text-primary",children:[s.repostedFrom&&r.jsxs("section",{className:"border-l-4 border-gray-300 dark:border-gray-600 pl-4 mb-4 text-sm text-secondary",children:["♻️ Reposted from @",s.repostedFrom.username]}),r.jsxs("section",{children:[r.jsx(L,{post:s,showDetails:!0}),v&&r.jsx("div",{className:"mt-4",children:r.jsx(U,{replyTo:s,initialType:F||void 0,initialContent:B&&u?`Hi @${(I=s.author)==null?void 0:I.username}, I'm @${u.username} and would like to join.`:void 0,onSave:()=>{f(!1),h(k.POST(s.id),{replace:!0}),i()},onCancel:()=>{f(!1),h(k.POST(s.id),{replace:!0})}})})]}),r.jsx("section",{children:E?r.jsx(H,{boardId:`thread-${e}`,board:E,layout:"grid",onScrollEnd:N,loading:p,editable:!1,compact:!0,initialExpanded:!0,user:u}):r.jsx(T,{})})]}):r.jsx(T,{})};export{te as default};
