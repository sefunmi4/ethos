import{h as q,u as v,b as w,r as s,i as Q,j as e,a as h}from"./index-CxzMjhE-.js";import{u as P}from"./useQuest-BW7Znkqp.js";import{u as f}from"./useBoard-BWIqxM7N.js";import{u as C}from"./useSocket-B9IG26Ws.js";import{B as L}from"./Banner-C5qimYCt.js";import{B as b}from"./Board-DvHUsBFG.js";import{B as S}from"./Button-BBg8DJkg.js";import{p as k}from"./quest-3nETprwz.js";import{R as E}from"./ReviewForm-yoZxRLyo.js";import"./useGraph-Br1XlEWj.js";import"./post-BFgSlzkn.js";import"./GridLayout-DEWRpfJd.js";import"./displayUtils-C2lD-HWY.js";import"./AvatarStack-DgfcvvW3.js";import"./usePermissions-alxmqwVa.js";import"./review-ZbVpCwUE.js";const X=()=>{var x;const{id:a}=q(),{user:r}=v();let c=!0;try{w()}catch{c=!1}const[l,j]=s.useState(null),[p,g]=s.useState(null),[y,i]=s.useState(""),{quest:t,error:B,isLoading:I}=P(a??"");s.useEffect(()=>{if(t){if(t.author&&t.author.username){i(t.author.username);return}Q(t.authorId).then(o=>i(o.username||o.id)).catch(()=>i(t.authorId))}},[t]);const{board:d,refresh:m}=f(`map-${a}`),{board:n,refresh:u}=f(`log-${a}`);C("board:update",o=>{o.questId===a&&(o.layout==="graph"&&(m==null||m()),o.layout==="grid"&&(u==null||u()))}),s.useEffect(()=>{d&&j(d),n&&g(n)},[d,n]);const N=async()=>{if(t&&window.confirm("Promote this quest to a project?"))try{await k(t.id),alert("Quest promoted to project")}catch(o){console.error("[QuestPage] promote failed:",o),alert("Failed to promote quest")}};return B?e.jsx("div",{className:"p-6 text-center text-red-500",children:"This quest could not be loaded or is private."}):I||!t?e.jsx(h,{}):e.jsxs("main",{className:"max-w-6xl mx-auto px-4 py-10 space-y-12 bg-soft dark:bg-soft-dark text-primary",children:[e.jsx(L,{quest:t,creatorName:y}),(r==null?void 0:r.id)===t.authorId&&e.jsx("div",{className:"mb-4",children:e.jsx(S,{variant:"secondary",onClick:N,children:"Promote to Project"})}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4",children:"üó∫ Quest Map"}),l&&c?e.jsx(b,{boardId:`map-${a}`,board:l,layout:"map-graph",editable:(r==null?void 0:r.id)===t.authorId,quest:t,user:r,showCreate:!0}):e.jsx(h,{})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-xl font-semibold text-primary mb-4",children:"üìú Quest Log"}),p?e.jsx(b,{boardId:`log-${a}`,board:p,layout:"grid",editable:(r==null?void 0:r.id)===t.authorId||((x=t.collaborators)==null?void 0:x.some(o=>o.userId===(r==null?void 0:r.id))),quest:t,user:r,showCreate:!0}):e.jsx("p",{className:"text-sm text-secondary",children:"No quest logs yet. Start journaling progress."})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-xl font-semibold text-primary mb-4",children:"‚≠ê Leave a Review"}),e.jsx(E,{targetType:"quest",questId:t.id})]})]})};export{X as default};
