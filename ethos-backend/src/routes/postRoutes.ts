import express, { Request, Response } from 'express';
import { v4 as uuidv4 } from 'uuid';
import { authMiddleware } from '../middleware/authMiddleware';
import { postsStore, usersStore, reactionsStore } from '../models/stores';
import { enrichPost } from '../utils/enrich';
import type { DBPost } from '../types/db';
import type { AuthenticatedRequest } from '../types/express';

const router = express.Router();

//
// âœ… POST create a new post
//
router.post(
  '/',
  authMiddleware,
  (req: AuthenticatedRequest, res: Response): void => {
    const {
      type = 'free_speech',
      content = '',
      visibility = 'public',
      tags = [],
      questId = null,
    } = req.body;

    const posts = postsStore.read();

    const newPost: DBPost = {
      id: uuidv4(),
      authorId: req.user!.id,
      type,
      content,
      visibility,
      timestamp: new Date().toISOString(),
      tags,
      collaborators: [],
      replyTo: null,
      repostedFrom: null,
      linkedItems: [],
      questId,
    };

    posts.push(newPost);
    postsStore.write(posts);
    const users = usersStore.read();
    res.status(201).json(enrichPost(newPost, { users }));
  }
);

//
// âœ… PATCH update post
//
router.patch(
  '/:id',
  authMiddleware,
  (req: AuthenticatedRequest<{ id: string }>, res: Response): void => {
    const posts = postsStore.read();
    const post = posts.find((p) => p.id === req.params.id);
    if (!post) {
      res.status(404).json({ error: 'Post not found' });
      return;
    }

    Object.assign(post, req.body);
    postsStore.write(posts);
    const users = usersStore.read();
    res.json(enrichPost(post, { users }));
  }
);
//
// âœ… GET /api/posts/:id/replies â€“ Fetch direct replies to a post
//
router.get('/:id/replies', (req: Request<{ id: string }>, res: Response) => {
  const posts = postsStore.read();
  const replies = posts.filter((p) => p.replyTo === req.params.id);
  const users = usersStore.read();
  res.json({ replies: replies.map((p) => enrichPost(p, { users })) });
});

//
// âœ… POST /api/posts/:id/repost â€“ Repost a post
//
//
// âœ… POST /api/posts/:id/repost â€“ Repost a post
//
router.post(
  '/:id/repost',
  authMiddleware,
  (req: AuthenticatedRequest<{ id: string }>, res: Response): void => {
    const posts = postsStore.read();
    const original = posts.find((p) => p.id === req.params.id);
    if (!original) return void res.status(404).json({ error: 'Original post not found' });

    const users = usersStore.read();
    const authorUsername = users.find(u => u.id === req.user!.id)?.username || '';
    const originalAuthorUsername = users.find(u => u.id === original.authorId)?.username || '';

    const repost: DBPost = {
      id: uuidv4(),
      authorId: req.user!.id,
      type: original.type,
      content: original.content,
      visibility: original.visibility,
      questId: original.questId || null,
      tags: [...(original.tags || [])],
      collaborators: [], // reposts are solo unless explicitly assigned
      replyTo: null,
      timestamp: new Date().toISOString(),
      repostedFrom: original.id,
      linkedItems: [...(original.linkedItems || [])],

      // ðŸ§¹ Clear non-transferable or enriched fields
      enriched: false,
      systemGenerated: false,
      autoGeneratedReason: undefined,
      status: undefined,
      questNodeTitle: undefined,
      nodeId: undefined,
      linkedNodeId: undefined,
      gitDiff: undefined,
      commitSummary: undefined,
      reactions: undefined,
      reactionCounts: undefined,
    };

    posts.push(repost);
    postsStore.write(posts);
    res.status(201).json(enrichPost(repost, { users }));
  }
);

//
// âœ… GET /api/posts/:id/reposts/user â€“ Get current user's repost of a post
//
router.get(
  '/:id/reposts/user',
  authMiddleware,
  (req: AuthenticatedRequest<{ id: string }>, res: Response): void => {
    const posts = postsStore.read();
    const repost = posts.find(
      (p) => p.repostedFrom === req.params.id && p.authorId === req.user!.id
    );
    const users = usersStore.read();
    res.json(repost ? enrichPost(repost, { users }) : null);
  }
);

//
// âœ… GET /api/posts/:id/reposts/count â€“ Count of reposts
//
router.get('/:id/reposts/count', (_req: Request<{ id: string }>, res: Response) => {
  const posts = postsStore.read();
  const count = posts.filter((p) => p.repostedFrom === _req.params.id).length;
  res.json({ count });
});

//
// âœ… POST /api/posts/:id/reactions/:type â€“ Toggle reaction (like/heart)
//
router.post(
  '/:id/reactions/:type',
  authMiddleware,
  (req: AuthenticatedRequest<{ id: string; type: string }>, res: Response): void => {
    const { id, type } = req.params;
    const userId = req.user!.id;
    const reactions = reactionsStore.read();
    const key = `${id}_${userId}_${type}`;

    if (!reactions.includes(key)) {
      reactions.push(key);
      reactionsStore.write(reactions);
    }

    res.json({ success: true });
  }
);

//
// âœ… DELETE /api/posts/:id/reactions/:type â€“ Remove reaction
//
router.delete(
  '/:id/reactions/:type',
  authMiddleware,
  (req: AuthenticatedRequest<{ id: string; type: string }>, res: Response): void => {
    const { id, type } = req.params;
    const userId = req.user!.id;
    const reactions = reactionsStore.read();
    const index = reactions.indexOf(`${id}_${userId}_${type}`);

    if (index !== -1) {
      reactions.splice(index, 1);
      reactionsStore.write(reactions);
    }

    res.json({ success: true });
  }
);

//
// âœ… GET /api/posts/:id/reactions â€“ Get all reactions on a post
//
router.get('/:id/reactions', (req: Request<{ id: string }>, res: Response) => {
  const { id } = req.params;
  const reactions = reactionsStore.read();
  const postReactions = reactions
    .filter((r) => r.startsWith(`${id}_`))
    .map((r) => {
      const [, userId, type] = r.split('_');
      return { userId, type };
    });

  res.json(postReactions);
});

//
// âœ… POST /api/posts/:id/solve â€“ Mark a post as solved
//
router.post(
  '/:id/solve',
  authMiddleware,
  (req: AuthenticatedRequest<{ id: string }>, res: Response): void => {
    const posts = postsStore.read();
    const post = posts.find((p) => p.id === req.params.id);
    if (!post) return void res.status(404).json({ error: 'Post not found' });

    post.tags = [...(post.tags || []), 'solved'];
    postsStore.write(posts);
    res.json({ success: true });
  }
);

//
// âœ… GET /api/posts/:id/linked â€“ Get all posts linked to a post
//
router.get('/:id/linked', (req: Request<{ id: string }>, res: Response) => {
  const posts = postsStore.read();
  const linked = posts.filter((p) =>
    p.linkedItems?.some((item) => item.itemId === req.params.id)
  );
  const users = usersStore.read();
  res.json({ posts: linked.map((p) => enrichPost(p, { users })) });
});

//
// âœ… GET /api/posts/:id/propagation-status â€“ Simulate cascade status
//
router.get('/:id/propagation-status', (req: Request<{ id: string }>, res: Response) => {
  // This is a placeholder â€“ you can replace with actual propagation logic
  const affected = [req.params.id];
  res.json({ cascadeCompleted: true, affectedIds: affected });
});

export default router;
